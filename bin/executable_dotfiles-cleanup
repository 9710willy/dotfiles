#!/bin/bash
# dotfiles-cleanup - Clean up caches and temporary files
# Usage: dotfiles-cleanup [--dry-run]

set -euo pipefail

DRY_RUN=false
[[ "${1:-}" == "--dry-run" ]] && DRY_RUN=true

bytes_freed=0

cleanup() {
    local name="$1"
    local path="$2"

    if [[ -e "$path" ]]; then
        local size=$(du -sk "$path" 2>/dev/null | cut -f1 || echo 0)
        if [[ "$DRY_RUN" == "true" ]]; then
            echo "[DRY RUN] Would remove: $name (~${size}KB)"
        else
            rm -rf "$path"
            echo "Removed: $name (~${size}KB)"
            bytes_freed=$((bytes_freed + size))
        fi
    fi
}

echo "=== Dotfiles Cleanup ==="
[[ "$DRY_RUN" == "true" ]] && echo "(Dry run mode - no files will be deleted)"
echo ""

echo "Homebrew:"
if command -v brew &>/dev/null; then
    if [[ "$DRY_RUN" == "true" ]]; then
        echo "[DRY RUN] Would run: brew cleanup --prune=all"
        brew cleanup --dry-run 2>/dev/null | head -5
    else
        brew cleanup --prune=all -s
        echo "Cleaned Homebrew caches"
    fi
fi

echo ""
echo "mise (version manager):"
if command -v mise &>/dev/null; then
    if [[ "$DRY_RUN" == "true" ]]; then
        echo "[DRY RUN] Would run: mise prune"
    else
        mise prune -y 2>/dev/null || true
        echo "Pruned unused mise versions"
    fi
fi

echo ""
echo "npm/yarn caches:"
cleanup "npm cache" "$HOME/.npm/_cacache"
cleanup "yarn cache" "$HOME/.cache/yarn"
cleanup "pnpm cache" "$HOME/.local/share/pnpm/store"

echo ""
echo "Python caches:"
cleanup "pip cache" "$HOME/.cache/pip"
cleanup "pipx cache" "$HOME/.cache/pipx"

echo ""
echo "Docker (if installed):"
if command -v docker &>/dev/null; then
    if [[ "$DRY_RUN" == "true" ]]; then
        echo "[DRY RUN] Would run: docker system prune -f"
    else
        docker system prune -f 2>/dev/null || echo "  (Docker not running)"
    fi
fi

echo ""
echo "macOS caches:"
cleanup "Xcode DerivedData" "$HOME/Library/Developer/Xcode/DerivedData"
cleanup "CocoaPods cache" "$HOME/Library/Caches/CocoaPods"

echo ""
echo "=== Cleanup Complete ==="
if [[ "$DRY_RUN" == "false" ]]; then
    echo "Freed approximately $((bytes_freed / 1024))MB"
else
    echo "Run without --dry-run to actually clean up"
fi
