#!/bin/bash
# dotfiles-health - Validate dotfiles setup
# Usage: dotfiles-health

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

passed=0
failed=0
warned=0

check() {
    local name="$1"
    local cmd="$2"

    if eval "$cmd" &>/dev/null; then
        echo -e "${GREEN}✓${NC} $name"
        ((passed++))
    else
        echo -e "${RED}✗${NC} $name"
        ((failed++))
    fi
}

warn() {
    local name="$1"
    local cmd="$2"

    if eval "$cmd" &>/dev/null; then
        echo -e "${GREEN}✓${NC} $name"
        ((passed++))
    else
        echo -e "${YELLOW}⚠${NC} $name (optional)"
        ((warned++))
    fi
}

echo "=== Dotfiles Health Check ==="
echo ""

echo "Core Tools:"
check "chezmoi installed" "command -v chezmoi"
check "neovim installed" "command -v nvim"
check "tmux installed" "command -v tmux"
check "git installed" "command -v git"

echo ""
echo "Shell:"
check "zsh is default shell" "[[ \$SHELL == */zsh ]]"
check "powerlevel10k installed" "[[ -d ~/powerlevel10k ]]"
check "zsh plugins installed" "[[ -d ~/.oh-my-zsh/custom/plugins/fast-syntax-highlighting ]]"

echo ""
echo "Version Managers:"
check "mise installed" "command -v mise"
check "mise node available" "mise current node"
check "mise python available" "mise current python"
check "corepack enabled" "command -v yarn"

echo ""
echo "CLI Enhancements:"
check "bat installed" "command -v bat"
check "eza installed" "command -v eza"
check "fzf installed" "command -v fzf"
check "ripgrep installed" "command -v rg"
check "fd installed" "command -v fd"
check "zoxide installed" "command -v zoxide"
check "delta installed" "command -v delta"

echo ""
echo "Development:"
check "docker installed" "command -v docker"
check "gh (GitHub CLI) installed" "command -v gh"
check "jq installed" "command -v jq"

echo ""
echo "Git Config:"
check "git user.name set" "git config --global user.name"
check "git user.email set" "git config --global user.email"
warn "git GPG signing" "git config --global commit.gpgsign | grep -q true"

echo ""
echo "Optional:"
warn "SSH key exists" "[[ -f ~/.ssh/id_ed25519 ]]"
warn "GPG key exists" "gpg --list-secret-keys 2>/dev/null | grep -q sec"

echo ""
echo "=== Summary ==="
echo -e "${GREEN}Passed: $passed${NC}"
[[ $warned -gt 0 ]] && echo -e "${YELLOW}Warnings: $warned${NC}"
[[ $failed -gt 0 ]] && echo -e "${RED}Failed: $failed${NC}"

exit $failed
