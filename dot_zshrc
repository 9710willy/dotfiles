# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# =============================================================================
# PATH Setup (order matters - later entries take precedence)
# =============================================================================
# Homebrew (base for many tools)
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# User local binaries
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"
# Bun (JavaScript runtime/bundler - before mise so mise's node takes precedence)
if [[ -d "$HOME/.bun" ]]; then
  export BUN_INSTALL="$HOME/.bun"
  export PATH="$BUN_INSTALL/bin:$PATH"
  [ -s "$BUN_INSTALL/_bun" ] && source "$BUN_INSTALL/_bun"
fi

# mise - universal version manager (MUST be last to take precedence)
# Manages: node, python, ruby, go, rust, etc.
if command -v mise &> /dev/null; then
  eval "$(mise activate zsh)"
fi

# =============================================================================
# Prompt
# =============================================================================
source ~/powerlevel10k/powerlevel10k.zsh-theme

# Load plugins
export ZSH_PLUGINS="$HOME/.oh-my-zsh/custom/plugins"

source ${ZSH_PLUGINS}/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh
source ${ZSH_PLUGINS}/zsh-autosuggestions/zsh-autosuggestions.zsh
source ${ZSH_PLUGINS}/zsh-history-substring-search/zsh-history-substring-search.zsh

# bind UP and DOWN arrow keys to history substring search
zmodload zsh/terminfo
bindkey "$terminfo[kcuu1]" history-substring-search-up
bindkey "$terminfo[kcud1]" history-substring-search-down
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

# =============================================================================
# Completion System (cached for performance)
# =============================================================================
autoload -Uz compinit
# Only regenerate completion dump once a day
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C  # Skip security check for speed
fi

# Completion styling
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'  # Case insensitive
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path ~/.zsh/cache

# =============================================================================
# Shell Options
# =============================================================================
setopt correct
setopt extendedglob
setopt nocaseglob
setopt rcexpandparam
setopt nocheckjobs
setopt numericglobsort
setopt auto_cd

# History
HISTFILE=~/.zhistory
HISTSIZE=50000
SAVEHIST=50000
setopt appendhistory
setopt histignorealldups
setopt hist_ignore_space      # Don't save commands starting with space
unsetopt share_history        # Don't share history between shells

# =============================================================================
# Environment
# =============================================================================
export EDITOR='nvim'

# Eza colors (gruvbox theme)
export EZA_COLORS="di=38;5;109:ln=38;5;108:ex=38;5;142:fi=38;5;223:\
ur=38;5;214:uw=38;5;167:ux=38;5;142:ue=38;5;142:\
gr=38;5;214:gw=38;5;167:gx=38;5;142:\
tr=38;5;214:tw=38;5;167:tx=38;5;142:\
sn=38;5;142:sb=38;5;108:\
da=38;5;109:\
uu=38;5;214:uR=38;5;124:\
gu=38;5;214:gR=38;5;124:\
ga=38;5;142:gm=38;5;214:gd=38;5;167:gv=38;5;167:gt=38;5;108"

# =============================================================================
# Aliases
# =============================================================================

# Editor
alias vim='nvim'

# Navigation
alias ..='cd ..'
alias ...='cd ../..'

# Modern CLI replacements
alias ls='eza'
alias ll='eza -la --git --icons'
alias la='eza -a'
alias lt='eza --tree --level=2'
alias cat='bat --paging=never'

# Git shortcuts
alias g='git'
alias gs='git status -sb'
alias gd='git diff'
alias gco='git checkout'
alias gp='git push'
alias gl='git pull --rebase'
alias glog='git log --oneline --graph -20'

# Docker
alias d='docker'
alias dc='docker compose'
alias dps='docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# Quick edits
alias zshrc='nvim ~/.zshrc'
alias reload='source ~/.zshrc'

# Claude Code session management
alias ccs='cc -s'          # Switch Claude sessions
alias ccl='cc -l'          # List Claude sessions
alias cck='cc -k'          # Kill a Claude session
alias ccK='cc -K'          # Kill all Claude sessions
alias ccwork='cc ~/work'
alias ccdot='cc ~/dotfiles'

# =============================================================================
# Helper Functions
# =============================================================================

# Quick directory creation and cd
mkcd() { mkdir -p "$1" && cd "$1"; }

# Find and replace in files (uses ripgrep + sed)
replace() {
  if [[ $# -ne 3 ]]; then
    echo "Usage: replace <search> <replace> <glob>"
    echo "Example: replace 'oldFunc' 'newFunc' '**/*.ts'"
    return 1
  fi
  rg -l "$1" -g "$3" | xargs sed -i '' "s/$1/$2/g"
}

# Git branch cleanup - delete merged branches
git-cleanup() {
  git fetch -p
  git branch -vv | grep ': gone]' | awk '{print $1}' | xargs -r git branch -D
}

# Port finder - what's using a port?
port() {
  lsof -i ":$1" | grep LISTEN
}

# Quick HTTP server
serve() {
  local port="${1:-8000}"
  echo "Serving on http://localhost:$port"
  python3 -m http.server "$port"
}

# Extract any archive
extract() {
  if [[ -f "$1" ]]; then
    case "$1" in
      *.tar.bz2) tar xjf "$1" ;;
      *.tar.gz)  tar xzf "$1" ;;
      *.tar.xz)  tar xJf "$1" ;;
      *.bz2)     bunzip2 "$1" ;;
      *.gz)      gunzip "$1" ;;
      *.tar)     tar xf "$1" ;;
      *.tbz2)    tar xjf "$1" ;;
      *.tgz)     tar xzf "$1" ;;
      *.zip)     unzip "$1" ;;
      *.Z)       uncompress "$1" ;;
      *.7z)      7z x "$1" ;;
      *)         echo "'$1' cannot be extracted" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# =============================================================================
# Tool Integrations (load after PATH is set)
# =============================================================================

# fzf - fuzzy finder with enhanced defaults
if [ -f ~/.fzf.zsh ]; then
  source ~/.fzf.zsh
  export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --preview-window=right:50%"
  # Use fd for faster file finding (respects .gitignore)
  command -v fd &>/dev/null && export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi

# fzf + git integration
fzf-git-branch() {
  git branch --all --sort=-committerdate |
    grep -v HEAD |
    fzf --preview 'git log --oneline --graph -20 {}' |
    sed 's/^[* ]*//' |
    sed 's#remotes/origin/##'
}

# Ctrl+G to switch git branches with preview
fzf-git-checkout() {
  local branch=$(fzf-git-branch)
  [[ -n "$branch" ]] && git checkout "$branch"
}
zle -N fzf-git-checkout
bindkey '^G' fzf-git-checkout

# zoxide - smart cd
command -v zoxide &> /dev/null && eval "$(zoxide init zsh)"

# direnv - auto-load project environment variables
command -v direnv &> /dev/null && eval "$(direnv hook zsh)"

# Machine-local config (not tracked by chezmoi)
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# p10k config (must be at the end)
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
