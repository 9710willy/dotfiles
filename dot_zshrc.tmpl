{{- /* Determine Homebrew prefix based on OS and architecture */ -}}
{{- $brewPrefix := "" -}}
{{- $isMac := eq .chezmoi.os "darwin" -}}
{{- $isLinux := eq .chezmoi.os "linux" -}}
{{- if $isMac -}}
{{-   if eq .chezmoi.arch "arm64" -}}
{{-     $brewPrefix = "/opt/homebrew" -}}
{{-   else -}}
{{-     $brewPrefix = "/usr/local" -}}
{{-   end -}}
{{- end -}}
# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# =============================================================================
# PATH Setup (order matters - later entries take precedence)
# =============================================================================

{{- if or $isMac (ne $brewPrefix "") }}
# Homebrew (base for many tools)
if [[ -x {{ $brewPrefix }}/bin/brew ]]; then
  eval "$({{ $brewPrefix }}/bin/brew shellenv)"
fi
{{- end }}

# User local binaries
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

{{- if $isMac }}
# Bun (JavaScript runtime/bundler - before mise so mise's node takes precedence)
if [[ -d "$HOME/.bun" ]]; then
  export BUN_INSTALL="$HOME/.bun"
  export PATH="$BUN_INSTALL/bin:$PATH"
  [ -s "$BUN_INSTALL/_bun" ] && source "$BUN_INSTALL/_bun"
fi
{{- end }}

# mise - universal version manager (MUST be last to take precedence)
# Manages: node, python, ruby, go, rust, etc.
if command -v mise &> /dev/null; then
  eval "$(mise activate zsh)"
  # Enable corepack for yarn/pnpm support with mise-managed node
  corepack enable 2>/dev/null
fi

# =============================================================================
# Prompt
# =============================================================================
source ~/powerlevel10k/powerlevel10k.zsh-theme

# Load plugins
export ZSH_PLUGINS="$HOME/.oh-my-zsh/custom/plugins"

source ${ZSH_PLUGINS}/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh
source ${ZSH_PLUGINS}/zsh-autosuggestions/zsh-autosuggestions.zsh
source ${ZSH_PLUGINS}/zsh-history-substring-search/zsh-history-substring-search.zsh

# bind UP and DOWN arrow keys to history substring search
zmodload zsh/terminfo
bindkey "$terminfo[kcuu1]" history-substring-search-up
bindkey "$terminfo[kcud1]" history-substring-search-down
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

# =============================================================================
# Shell Options
# =============================================================================
setopt correct
setopt extendedglob
setopt nocaseglob
setopt rcexpandparam
setopt nocheckjobs
setopt numericglobsort
setopt auto_cd

# History
HISTFILE=~/.zhistory
HISTSIZE=10000
SAVEHIST=10000
setopt appendhistory
setopt histignorealldups
setopt hist_ignore_space      # Don't save commands starting with space
unsetopt share_history        # Don't share history between shells

# =============================================================================
# Environment
# =============================================================================
export EDITOR='nvim'

# Eza colors (gruvbox theme)
export EZA_COLORS="di=38;5;109:ln=38;5;108:ex=38;5;142:fi=38;5;223:\
ur=38;5;214:uw=38;5;167:ux=38;5;142:ue=38;5;142:\
gr=38;5;214:gw=38;5;167:gx=38;5;142:\
tr=38;5;214:tw=38;5;167:tx=38;5;142:\
sn=38;5;142:sb=38;5;108:\
da=38;5;109:\
uu=38;5;214:uR=38;5;124:\
gu=38;5;214:gR=38;5;124:\
ga=38;5;142:gm=38;5;214:gd=38;5;167:gv=38;5;167:gt=38;5;108"

# =============================================================================
# Aliases
# =============================================================================

# macOS specific
{{- if $isMac }}
alias ibrew='arch -x86_64 /usr/local/bin/brew'
{{- end }}

# Editor
alias vim='nvim'

# Navigation
alias ..='cd ..'
alias ...='cd ../..'

# Modern CLI replacements
alias ls='eza'
alias ll='eza -la --git --icons'
alias la='eza -a'
alias lt='eza --tree --level=2'
alias cat='bat --paging=never'

# Git shortcuts
alias g='git'
alias gs='git status -sb'
alias gd='git diff'
alias gco='git checkout'
alias gp='git push'
alias gl='git pull --rebase'
alias glog='git log --oneline --graph -20'

# Docker
alias d='docker'
alias dc='docker compose'
alias dps='docker ps --format "table {{`{{.Names}}`}}\t{{`{{.Status}}`}}\t{{`{{.Ports}}`}}"'

# Quick edits
alias zshrc='nvim ~/.zshrc'
alias reload='source ~/.zshrc'

# Claude Code session management
alias ccs='cc -s'          # Switch Claude sessions
alias ccl='cc -l'          # List Claude sessions
alias cck='cc -k'          # Kill a Claude session
alias ccK='cc -K'          # Kill all Claude sessions
alias ccwork='cc ~/work'
alias ccdot='cc ~/dotfiles'

# =============================================================================
# Tool Integrations (load after PATH is set)
# =============================================================================

# fzf - fuzzy finder
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# zoxide - smart cd
command -v zoxide &> /dev/null && eval "$(zoxide init zsh)"

# p10k config (must be at the end)
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
